<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINK Playlist</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@700&display=swap" rel="stylesheet">
    <link rel="icon" href="assets/favicon_Music.svg">
    <!-- Audio player libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --accent-color: #1DB954;
            --border-color: #333333;
            --hover-bg: #282828;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
            position: relative;
        }
        
        .artist-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .gradient-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3a1c71, #d76d77);
            opacity: 1;
            transition: opacity 1s ease-in-out;
        }
        
        .gradient-background.active {
            opacity: 1;
        }
        
        /* Remove the image-specific styles */
        /* .artist-background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            filter: blur(10px) brightness(0.3);
        }
        
        .artist-background-image.active {
            opacity: 1;
        } */
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        header {
            margin-bottom: 15px;
            text-align: center;
        }
        
        h1 {
            font-size: 60pt; /* Base size for large screens */
            font-weight: 700;
            margin-bottom: 8px;
            font-family: 'Roboto', sans-serif;
            white-space: nowrap; /* Prevent wrapping to new line */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Show ellipsis if text overflows */
        }
        
        /* Responsive font size adjustments */
        @media (max-width: 768px) {
            h1 {
                font-size: 40pt; /* Smaller size for tablets */
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 30pt; /* Even smaller for mobile phones */
            }
        }
        
        .subtitle {
            color: black; /* Maak de subtitle zwart */
            font-size: 14px;
        }
        
        /* Audio Player Styles */
        .audio-player {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .player-controls {
            display: flex;
            align-items: center;
        }
        
        .play-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 15px;
            transition: all 0.2s;
        }
        
        .play-btn:hover {
            transform: scale(1.05);
            background-color: #1ed760;
        }
        
        .play-btn svg {
            width: 24px;
            height: 24px;
        }
        
        .player-info {
            flex: 1;
        }
        
        .station-name {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 4px;
        }
        
        .now-playing {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            margin-left: 20px;
        }
        
        .volume-icon {
            color: var(--text-secondary);
            margin-right: 8px;
        }
        
        .volume-slider {
            -webkit-appearance: none;
            width: 100px;
            height: 4px;
            border-radius: 2px;
            background: var(--border-color);
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
        }
        
        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: none;
        }
        
        .live-indicator {
            display: flex;
            align-items: center;
            margin-left: 15px;
            font-size: 12px;
            font-weight: 600;
            color: #ff4b4b;
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background-color: #ff4b4b;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .playlist-item-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            margin-right: 15px;
            background-color: var(--hover-bg);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-weight: bold;
            font-size: 20px;
        }
        
        .playlist-item-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .playlist {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .playlist-item {
            display: flex;
            align-items: center;
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            cursor: pointer;
            height: 125%; /* Increased height to 125% */
        }
        
        .playlist-item:hover {
            background-color: var(--hover-bg);
        }
        
        .playlist-item.active {
            background-color: rgba(29, 185, 84, 0.1);
            border-left: 3px solid var(--accent-color);
        }
        
        .playlist-item:last-child {
            border-bottom: none;
        }
        
        .playlist-item-info {
            flex: 1;
        }
        
        .playlist-item-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .playlist-item-artist {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .playlist-item-duration {
            color: var(--text-secondary);
            font-size: 14px;
            margin-left: 15px;
        }
        
        .playlist-item-timestamp {
            color: var(--text-secondary);
            font-size: 14px;
            margin-right: 15px;
            min-width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .playlist-item-actions {
            display: flex;
            align-items: center;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            margin-left: 10px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .action-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .youtube-btn {
            color: #FF0000;
        }
        
        .spotify-btn {
            color: #1DB954;
        }
        
        .refresh-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }
        
        .last-updated {
            color: black; /* Maak de last updated tekst zwart */
            font-size: 13px;
            text-align: right;
            margin-right: 20px; /* Align with the playlist table */
        }
        
        /* Verwijder de oude date-selector stijl */
        .date-selector {
            margin-right: auto;
        }
        
        .day-selector {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        /* Voeg nieuwe tabs stijl toe */
        .day-tabs {
            display: flex;
            background-color: var(--card-bg);
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            margin-bottom: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .day-tab {
            flex: 1;
            text-align: center;
            padding: 16px 5px; /* Increased height */
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s;
            font-size: 16px; /* Larger font */
            font-weight: 700; /* Bold font */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .day-tab .day-name {
            margin-bottom: 4px;
        }
        
        .day-tab .day-date {
            font-size: 11px;
            font-weight: 400;
            opacity: 0.8;
        }
        
        .day-tab:not(:last-child) {
            border-right: 1px solid var(--border-color);
        }
        
        .day-tab:hover {
            background-color: var(--hover-bg);
            color: var(--text-primary);
        }
        
        .day-tab.active {
            background-color: var(--hover-bg);
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
        }
        
        /* Style for refresh tab */
        .day-tab.refresh-tab {
            flex: 0.5;
            min-width: 60px;
            background-color: var(--card-bg);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .day-tab.refresh-tab:hover {
            background-color: var(--hover-bg);
            color: var(--text-primary);
        }
        
        .refresh-tab {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .refresh-tab svg {
            width: 16px;
            height: 16px;
        }
        
        /* Pas de playlist stijl aan om aan te sluiten bij de tabs */
        .playlist {
            background-color: var(--card-bg);
            border-radius: 0 0 12px 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .playlist-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .playlist-item:hover {
            background-color: var(--hover-bg);
        }
        
        .playlist-item.active {
            background-color: rgba(29, 185, 84, 0.1);
            border-left: 3px solid var(--accent-color);
        }
        
        .playlist-item:last-child {
            border-bottom: none;
        }
        
        .playlist-item-info {
            flex: 1;
        }
        
        .playlist-item-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .playlist-item-artist {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .playlist-item-duration {
            color: var(--text-secondary);
            font-size: 14px;
            margin-left: 15px;
        }
        
        .playlist-item-timestamp {
            color: var(--text-secondary);
            font-size: 14px;
            margin-right: 15px;
            min-width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .playlist-item-actions {
            display: flex;
            align-items: center;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            margin-left: 10px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .action-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .youtube-btn {
            color: #FF0000;
        }
        
        .spotify-btn {
            color: #1DB954;
        }
        
        .refresh-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }
        
        .last-updated {
            color: black; /* Maak de last updated tekst zwart */
            font-size: 13px;
            text-align: right;
            margin-right: 20px; /* Align with the playlist table */
        }
        
        .date-selector {
            margin-right: auto;
        }
        
        .day-selector {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .day-selector:hover {
            background-color: var(--hover-bg);
        }
        
        .day-selector option {
            background-color: var(--card-bg);
            color: var(--text-primary);
        }
        

        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Equalizer animation */
        .equalizer {
            display: flex;
            align-items: flex-end;
            height: 32px; /* Doubled the height */
            gap: 3px; /* Slightly increased gap */
            margin: 0 auto;
        }
        
        .equalizer-bar {
            width: 4px; /* Slightly wider bars */
            background-color: var(--accent-color);
            border-radius: 1px;
            transform-origin: bottom;
            animation: equalize 1.2s ease-in-out infinite;
        }
        
        .equalizer-bar:nth-child(1) { 
            animation-delay: 0.0s; 
            height: 10px;
            animation-duration: 0.7s; 
        }
        .equalizer-bar:nth-child(2) { 
            animation-delay: 0.3s; 
            height: 24px;
            animation-duration: 1.3s; 
        }
        .equalizer-bar:nth-child(3) { 
            animation-delay: 0.1s; 
            height: 14px;
            animation-duration: 0.8s; 
        }
        .equalizer-bar:nth-child(4) { 
            animation-delay: 0.4s; 
            height: 18px;
            animation-duration: 1.1s; 
        }
        
        @keyframes equalize {
            0% { transform: scaleY(0.3); }
            50% { transform: scaleY(1); }
            75% { transform: scaleY(0.6); }
            100% { transform: scaleY(0.3); }
        }
        
        .error {
            background-color: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        footer a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="artist-background" id="artist-background">
        <!-- Background images will be added here dynamically -->
    </div>
    
    <div class="container">
        <header>
            <img src="assets/Kink_FM_logo.svg" alt="KINK Logo" style="max-width: 100%; height: auto;">
            <p class="subtitle">Live updates of songs played on KINK radio station</p>
        </header>
        
        <!-- Audio Player -->
        <div class="audio-player" id="audio-player">
            <div class="player-controls">
                <button class="play-btn" id="play-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" id="play-icon">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" id="pause-icon" style="display: none;">
                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                    </svg>
                </button>
            </div>
            <div class="player-info">
                <div class="station-name">KINK Radio</div>
                <div class="now-playing" id="now-playing">Luister live naar KINK</div>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                LIVE
            </div>
            <div class="volume-control">
                <div class="volume-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                    </svg>
                </div>
                <input type="range" min="0" max="100" value="80" class="volume-slider" id="volume-slider">
            </div>
        </div>
        
        <div class="refresh-bar">
            
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
        </div>
        
        <div id="error" class="error">
            Failed to load playlist data. Please try again later.
        </div>
        
        <!-- Day tabs navigation -->
        <div id="day-tabs" class="day-tabs">
            <div class="day-tab refresh-tab" id="refresh-btn" title="Refresh Now">
                <div class="day-name">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="32" height="32">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                </div>
                <div class="day-date"></div>
            </div>
            <div class="day-tab" data-day="6">
                <div class="day-name">ZO</div>
                <div class="day-date">16-03</div>
            </div>
            <div class="day-tab" data-day="5">
                <div class="day-name">MA</div>
                <div class="day-date">17-03</div>
            </div>
            <div class="day-tab" data-day="4">
                <div class="day-name">DI</div>
                <div class="day-date">18-03</div>
            </div>
            <div class="day-tab" data-day="3">
                <div class="day-name">WO</div>
                <div class="day-date">19-03</div>
            </div>
            <div class="day-tab" data-day="2">
                <div class="day-name">DO</div>
                <div class="day-date">20-03</div>
            </div>
            <div class="day-tab" data-day="1">
                <div class="day-name">VR</div>
                <div class="day-date">21-03</div>
            </div>
            <div class="day-tab" data-day="0">
                <div class="day-name">ZA</div>
                <div class="day-date">22-03</div>
            </div>
        </div>
        
        <div id="playlist" class="playlist" style="display: none;">
            <!-- Playlist items will be inserted here -->
        </div>
        
        <!-- Bottom info bar -->
        <div class="refresh-bar">
            
        </div>
        
        <footer>
            <p>Data provided by <a href="https://onlineradiobox.com/nl/kink/playlist/" target="_blank" rel="noopener noreferrer">onlineradiobox.com</a></p>
        </footer>
    </div>
    
    <script>
        // DOM elements
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const playlistEl = document.getElementById('playlist');
        
        const artistBackgroundEl = document.getElementById('artist-background');
        const playBtn = document.getElementById('play-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const volumeSlider = document.getElementById('volume-slider');
        const nowPlayingEl = document.getElementById('now-playing');

        // Constants
        const BASE_PLAYLIST_URL = 'https://onlineradiobox.com/nl/kink/playlist/';
        const REFRESH_INTERVAL = 60; // seconds
        const RADIO_STREAM_URL = 'https://www.mp3streams.nl/zender/kink/stream/19-aac-128';
        
        // Initialize audio player with Howler.js
        let player = null;
        let isPlaying = false;
        
        // Variables
        let isRefreshing = false;
        let songs = [];
        let currentSongIndex = 0;
        let currentBackgroundImage = null;
        let selectedDay = 0; // 0 = today, 1 = yesterday, etc.

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize audio player
            initAudioPlayer();
            
            // Update day tabs with correct dates
            updateDayTabs();
            
            // Fetch playlist immediately when page loads
            fetchPlaylist();
            startAutoRefresh();
            
            // Add event listeners for day tabs
            const dayTabs = document.querySelectorAll('.day-tab');
            if (dayTabs.length > 0) {
                // Find Today tab (the last tab) and set it as active by default
                const todayTab = document.querySelector('.day-tab[data-day="0"]');
                if (todayTab) {
                    todayTab.classList.add('active');
                }
                
                // Add click event to each tab
                dayTabs.forEach(tab => {
                    if (tab.classList.contains('refresh-tab')) {
                        // Special handling for refresh tab
                        tab.addEventListener('click', function() {
                            // Don't change active state for refresh button
                            if (!isRefreshing) {
                                fetchPlaylist();
                            }
                        });
                    } else {
                        tab.addEventListener('click', function() {
                            // Remove active class from all tabs
                            dayTabs.forEach(t => t.classList.remove('active'));
                            
                            // Add active class to clicked tab
                            this.classList.add('active');
                            
                            // Update selected day and fetch playlist
                            selectedDay = parseInt(this.getAttribute('data-day'));
                            fetchPlaylist();
                        });
                    }
                });
                
                // Add event listener for refresh button
                const refreshBtn = document.getElementById('refresh-btn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', handleManualRefresh);
                }
            }
        });
        
        // Function to update day tabs with correct dates
        function updateDayTabs() {
            // Gebruik een datum object met de Nederlandse tijdzone (CET/CEST)
            // Voeg 5 uur toe aan de huidige tijd om te corrigeren voor het tijdsverschil
            const now = new Date();
            const cetOffset = 5 * 60 * 60 * 1000; // 5 uur in milliseconden
            const today = new Date(now.getTime() + cetOffset);
            
            const dayNames = ['ZO', 'MA', 'DI', 'WO', 'DO', 'VR', 'ZA'];
            
            // Update each day tab with the correct date
            for (let i = 0; i <= 6; i++) {
                const dayTab = document.querySelector(`.day-tab[data-day="${i}"]`);
                if (dayTab) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    
                    const dayName = dayNames[date.getDay()];
                    const formattedDate = `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    const dayNameEl = dayTab.querySelector('.day-name');
                    const dayDateEl = dayTab.querySelector('.day-date');
                    
                    if (dayNameEl) dayNameEl.textContent = dayName;
                    if (dayDateEl) dayDateEl.textContent = formattedDate;
                }
            }
        }

        // Get playlist URL based on selected day
        function getPlaylistUrl() {
            if (selectedDay === 0) {
                // For today, use the base URL without any day parameter
                return 'https://onlineradiobox.com/nl/kink/playlist/';
            } else {
                // For other days, use the day parameter
                // The API expects 1=yesterday, 2=day before yesterday, etc.
                return `https://onlineradiobox.com/nl/kink/playlist/${selectedDay}`;
            }
        }

        // Fetch playlist data
        async function fetchPlaylist() {
            try {
                setRefreshing(true);
                showLoading(); // Show loading spinner

                const playlistUrl = getPlaylistUrl();
                console.log(`Fetching playlist from: ${playlistUrl}`);

                // Try multiple CORS proxies in sequence
                let response;
                let proxySuccess = false;
                let html = '';

                // List of CORS proxies to try
                const corsProxies = [
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(playlistUrl)}`,
                    `https://corsproxy.io/?${encodeURIComponent(playlistUrl)}`,
                    `https://cors-anywhere.herokuapp.com/${playlistUrl}`
                ];

                // Try each proxy until one works
                for (const proxyUrl of corsProxies) {
                    try {
                        console.log(`Trying proxy: ${proxyUrl}`);
                        response = await fetch(proxyUrl);

                        if (response.ok) {
                            html = await response.text();
                            console.log('HTML response length:', html.length);
                            console.log('HTML response first 100 chars:', html.substring(0, 100));
                            proxySuccess = true;
                            console.log(`Proxy successful: ${proxyUrl}`);
                            break;
                        }
                    } catch (proxyError) {
                        console.error(`Proxy failed: ${proxyUrl}`, proxyError);
                    }
                }

                if (!proxySuccess) {
                    throw new Error('All CORS proxies failed');
                }

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Find the playlist table - try different selectors
                let table = doc.querySelector('table.tablelist-schedule');

                if (!table) {
                    // Try alternative selectors if the first one fails
                    table = doc.querySelector('table.tablelist');
                    if (!table) {
                        table = doc.querySelector('table');
                    }
                }

                if (!table) {
                    // Log more details about the HTML content for debugging
                    console.error('Table not found in HTML. First 1000 characters:', html.substring(0, 1000));
                    throw new Error('Playlist table not found');
                }

                // Parse songs from the table
                const newSongs = [];
                const rows = table.querySelectorAll('tr');

                // Process each row in the table
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const cells = row.querySelectorAll('td');

                    if (cells.length >= 2) {
                        const timestamp = cells[0].textContent.trim();
                        const songText = cells[1].textContent.trim();

                        let artist = 'Unknown';
                        let title = songText;

                        if (songText.includes(' - ')) {
                            [artist, title] = songText.split(' - ', 2);
                        }

                        artist = artist.trim();
                        title = title.trim();

                        // Try to extract cover art from the row
                        let coverArt = null;
                        const imgElement = row.querySelector('img');
                        if (imgElement && imgElement.src) {
                            coverArt = imgElement.src;
                        }

                        // Generate album art color as fallback
                        const albumArtColor = generateAlbumArtColor(artist, title);

                        newSongs.push({
                            timestamp,
                            artist,
                            title,
                            isLive: timestamp.toLowerCase() === 'live',
                            coverArt,
                            albumArtColor,
                            duration: generateRandomDuration(),
                            id: null // Hier kan je de Spotify track-ID toevoegen als je die hebt
                        });
                    }
                }

                // Update songs array
                songs = newSongs;

                // Log de nieuwe nummers voor debugging
                console.log('Fetched songs:', songs);

                // Update the UI with the songs without hiding the playlist
                updatePlaylist(songs);
                showContent(); // Show content without hiding the playlist
            } catch (error) {
                console.error('Error fetching playlist:', error);
                showError();
            } finally {
                setRefreshing(false);
            }
        }

        // Generate random duration for display purposes
        function generateRandomDuration() {
            const minutes = Math.floor(Math.random() * 4) + 1;
            const seconds = Math.floor(Math.random() * 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Convert timestamp to Netherlands timezone (CET/CEST)
        function convertToNetherlandsTime(timestamp) {
            if (timestamp.toLowerCase() === 'live') {
                return timestamp;
            }
            
            try {
                // Parse the timestamp
                const [hours, minutes] = timestamp.split(':').map(Number);
                
                // Check if we need to adjust for timezone difference
                // Only apply correction for today's playlist (selectedDay === 0)
                let adjustedHours = hours;
                if (selectedDay === 0) {
                    // Adjust for 5 hour difference
                    adjustedHours = (hours + 5) % 24;
                }
                
                // Format as HH:MM with leading zeros
                return `${adjustedHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            } catch (error) {
                console.error('Error converting timestamp:', error);
                return timestamp; // Return original timestamp if conversion fails
            }
        }

        // Get initials from artist name
        function getInitials(name) {
            if (!name || name === 'Unknown') return '?';
            return name.split(' ')
                .map(word => word[0])
                .join('')
                .substring(0, 2)
                .toUpperCase();
        }

        // Update playlist in the UI
        function updatePlaylist(songs) {
            // Clear existing playlist
            playlistEl.innerHTML = '';
            
            
            
            // Update background with current artist (first song or live song)
            const currentSong = songs.find(song => song.isLive) || songs[0];
            if (currentSong) {
                updateArtistBackground(currentSong);
                updateNowPlaying(currentSong);
            }
            
            // Add songs to the playlist
            songs.forEach((song, index) => {
                const item = document.createElement('div');
                item.className = `playlist-item ${index === currentSongIndex ? 'active' : ''}`;
                
                // Timestamp
                const timestamp = document.createElement('div');
                timestamp.className = 'playlist-item-timestamp';
                
                if (song.isLive) {
                    // Create equalizer animation instead of LIVE text
                    const equalizer = document.createElement('div');
                    equalizer.className = 'equalizer';
                    
                    // Create 4 bars for the equalizer
                    for (let i = 0; i < 4; i++) {
                        const bar = document.createElement('div');
                        bar.className = 'equalizer-bar';
                        equalizer.appendChild(bar);
                    }
                    
                    timestamp.appendChild(equalizer);
                } else {
                    timestamp.textContent = convertToNetherlandsTime(song.timestamp);
                }
                
                // Thumbnail
                const thumbnail = document.createElement('div');
                thumbnail.className = 'playlist-item-thumbnail';
                
                if (song.coverArt) {
                    // Use actual cover art if available
                    const img = document.createElement('img');
                    img.src = song.coverArt;
                    img.alt = `${song.artist} - ${song.title}`;
                    img.onerror = function() {
                        // Fallback to color background with initials if image fails to load
                        this.style.display = 'none';
                        thumbnail.style.backgroundColor = song.albumArtColor;
                        thumbnail.textContent = getInitials(song.artist);
                    };
                    thumbnail.appendChild(img);
                } else {
                    // Use color background with initials as fallback
                    thumbnail.style.backgroundColor = song.albumArtColor;
                    thumbnail.textContent = getInitials(song.artist);
                }
                
                // Song info
                const info = document.createElement('div');
                info.className = 'playlist-item-info';
                
                const title = document.createElement('div');
                title.className = 'playlist-item-title';
                title.textContent = song.title;
                
                const artist = document.createElement('div');
                artist.className = 'playlist-item-artist';
                artist.textContent = song.artist;
                
                info.appendChild(title);
                info.appendChild(artist);
                
                // Actions
                const actions = document.createElement('div');
                actions.className = 'playlist-item-actions';
                
                // YouTube search button
                const youtubeBtn = document.createElement('button');
                youtubeBtn.className = 'action-btn youtube-btn';
                youtubeBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"></path></svg>';
                youtubeBtn.title = 'Search on YouTube';
                youtubeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // Open YouTube search in a new tab
                    window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(`${song.artist} ${song.title}`)}`, '_blank');
                });
                
                // Spotify search button
                const spotifyBtn = document.createElement('button');
                spotifyBtn.className = 'action-btn spotify-btn';
                spotifyBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.48.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"></path></svg>';
                spotifyBtn.title = 'Open in Spotify';
                spotifyBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Open de Spotify-zoeklink met de artiest en titel
                    window.open(`spotify:search:${encodeURIComponent(`${song.artist} ${song.title}`)}`, '_blank');
                });
                
                actions.appendChild(youtubeBtn);
                actions.appendChild(spotifyBtn);
                
                // Append all elements to the item
                item.appendChild(timestamp);
                item.appendChild(thumbnail);
                item.appendChild(info);
                item.appendChild(actions); // Voeg de acties toe aan het item
                
                // Append the item to the playlist
                playlistEl.appendChild(item);
            });
        }

        // Update artist background with a static gradient
        function updateArtistBackground(song) {
            // Skip if no song or same as current
            if (!song || (currentBackgroundImage && currentBackgroundImage.dataset.artist === song.artist)) {
                return;
            }
            
            // Create new gradient element
            const newGradient = document.createElement('div');
            newGradient.className = 'gradient-background';
            newGradient.dataset.artist = song.artist;
            
            // Generate a subtle gradient color based on song
            const colors = generateGradientColors(song.artist, song.title);
            newGradient.style.background = `linear-gradient(135deg, ${colors[0]}, ${colors[1]})`;
            newGradient.style.opacity = '0';
            newGradient.style.transition = 'opacity 1.5s ease-in-out';
            
            // Fade out existing gradients
            Array.from(artistBackgroundEl.children).forEach(child => {
                child.style.opacity = '0';
            });
            
            // Add new gradient and fade in
            artistBackgroundEl.appendChild(newGradient);
            setTimeout(() => {
                newGradient.style.opacity = '1';
            }, 50);
            
            // Remove old gradients after transition
            setTimeout(() => {
                Array.from(artistBackgroundEl.children)
                    .filter(child => child !== newGradient)
                    .forEach(child => child.remove());
            }, 1000);
        }
        
        // Generate gradient colors based on artist and title
        function generateGradientColors(artist, title) {
            // Create a deterministic hash from artist and title
            let hash = 0;
            const str = `${artist}${title}`;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            
            // Use positive hash value
            hash = Math.abs(hash);
            
            // Modern gradient color palettes (stylish combinations)
            const colorPalettes = [
                ['#3a1c71', '#d76d77'], // Purple to Pink
                ['#4568dc', '#b06ab3'], // Blue to Purple
                ['#0f2027', '#2c5364'], // Dark Blue shades
                ['#8e2de2', '#4a00e0'], // Vibrant Purple
                ['#141e30', '#243b55'], // Deep Blue
                ['#232526', '#414345'], // Slate Gray
                ['#1f1c2c', '#928dab'], // Midnight Purple
                ['#2b5876', '#4e4376'], // Blue to Purple
                ['#614385', '#516395'], // Lavender
                ['#16222a', '#3a6073'], // Steel Gray
                ['#1a2a6c', '#b21f1f'], // Deep Blue to Red
                ['#0f0c29', '#302b63'], // Deep Purple
                ['#12c2e9', '#c471ed'], // Blue to Pink
                ['#0b8793', '#360033'], // Teal to Purple
                ['#ff416c', '#ff4b2b']  // Pink to Orange
            ];
            
            // Select a palette based on the hash
            const paletteIndex = hash % colorPalettes.length;
            return colorPalettes[paletteIndex];
        }

        // Show loading state
        function showLoading() {
            loadingEl.style.display = 'flex';
            errorEl.style.display = 'none';
            playlistEl.style.display = 'none';
        }
        
        // Show content without hiding the playlist
        function showContent() {
            loadingEl.style.display = 'none';
            errorEl.style.display = 'none';
            playlistEl.style.display = 'block';
        }
        
        // Show error
        function showError() {
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
            playlistEl.style.display = 'none';
        }
        
        // Set refreshing state
        function setRefreshing(state) {
            isRefreshing = state;
        }

        // Remove these functions:
        async function getTopYouTubeVideoId(query) {
            const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=id&q=${encodeURIComponent(query)}&key=AIzaSyAP-qJzFwmVMxNk6xYzHAnq34qosPd0Wc8&type=video`);
            const data = await response.json();
            return data.items.length > 0 ? data.items[0].id.videoId : null;
        }

        // YouTube IFrame API ready callback
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                events: {
                    'onReady': onPlayerReady
                }
            });
        }

        // Event handler for when the player is ready
        function onPlayerReady(event) {
            // Player is ready
        }

        // Laad de YouTube-video in de widget
        function loadYouTubeVideo(artist, title) {
            const query = `${artist} ${title}`;
            getTopYouTubeVideoId(query).then(videoId => {
                if (videoId) {
                    player.loadVideoById(videoId);
                    document.getElementById('youtube-widget').style.display = 'block'; // Toon de widget
                } else {
                    alert('Geen video gevonden.');
                }
            });
        }
        
        // Generate album art color based on artist and title
        function generateAlbumArtColor(artist, title) {
            // Create a simple hash from the artist and title
            let hash = 0;
            const str = `${artist}${title}`;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            // Generate a HSL color with a good saturation and lightness
            const hue = Math.abs(hash) % 360;
            return `hsl(${hue}, 65%, 40%)`;
        }

        // Start auto-refresh timer
        function startAutoRefresh() {
            // Set an interval to fetch the playlist every 5 minutes
            setInterval(() => {
                if (!isRefreshing) {
                    fetchPlaylist();
                }
            }, 300000); // 300000 milliseconds = 5 minutes
        }
        
        // Handle manual refresh button click
        function handleManualRefresh() {
            if (!isRefreshing) {
                fetchPlaylist();
            }
        }
        // Call fetchPlaylist immediately when script loads to ensure fresh data
        fetchPlaylist();
        
        // Initialize audio player with Howler.js
        function initAudioPlayer() {
            // Create Howler instance for streaming
            player = new Howl({
                src: [RADIO_STREAM_URL],
                html5: true, // Use HTML5 Audio for streaming
                preload: false, // Don't preload the stream
                volume: 0.8, // Initial volume at 80%
                onplay: function() {
                    isPlaying = true;
                    updatePlayerUI();
                    console.log('Radio stream started playing');
                },
                onpause: function() {
                    isPlaying = false;
                    updatePlayerUI();
                    console.log('Radio stream paused');
                },
                onstop: function() {
                    isPlaying = false;
                    updatePlayerUI();
                    console.log('Radio stream stopped');
                },
                onloaderror: function() {
                    console.error('Error loading radio stream');
                    alert('Er is een probleem met het laden van de radiostream. Probeer het later opnieuw.');
                },
                onplayerror: function() {
                    console.error('Error playing radio stream');
                    alert('Er is een probleem met het afspelen van de radiostream. Probeer het later opnieuw.');
                }
            });
            
            // Add event listener for play/pause button
            playBtn.addEventListener('click', togglePlay);
            
            // Add event listener for volume slider
            volumeSlider.addEventListener('input', function() {
                const volume = this.value / 100;
                if (player) {
                    player.volume(volume);
                }
            });
        }
        
        // Toggle play/pause
        function togglePlay() {
            if (!player) {
                // Initialize the player with the streaming URL
                player = new Howl({
                    src: ['https://www.mp3streams.nl/zender/kink/stream/19-aac-128'], // Use the streaming URL
                    html5: true, // Use the HTML5 Audio API for the stream
                    volume: 0.8,
                    onplay: function() {
                        isPlaying = true;
                        updatePlayerUI();
                        console.log('Radio stream started playing');
                    },
                    onpause: function() {
                        isPlaying = false;
                        updatePlayerUI();
                        console.log('Radio stream paused');
                    },
                    onstop: function() {
                        isPlaying = false;
                        updatePlayerUI();
                        console.log('Radio stream stopped');
                    },
                    onloaderror: function() {
                        console.error('Error loading radio stream');
                        alert('Er is een probleem met het laden van de radiostream. Probeer het later opnieuw.');
                    },
                    onplayerror: function() {
                        console.error('Error playing radio stream');
                        alert('Er is een probleem met het afspelen van de radiostream. Probeer het later opnieuw.');
                    }
                });
                player.play(); // Start the audio stream
            } else {
                if (isPlaying) {
                    player.pause(); // Pause the current stream
                } else {
                    player.play(); // Resume the current stream
                }
            }
            updatePlayerUI(); // Update the UI after toggling
        }
        
        // Update player UI based on play state
        function updatePlayerUI() {
            if (isPlaying) {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
                nowPlayingEl.textContent = 'Live luisteren naar KINK';
            } else {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                nowPlayingEl.textContent = 'Klik om live te luisteren';
            }
        }
        
        // Update now playing info when a new song is detected
        function updateNowPlaying(song) {
            if (song && isPlaying) {
                nowPlayingEl.textContent = `Nu op KINK: ${song.artist} - ${song.title}`;
            }
        }
    </script>
</body>
</html>