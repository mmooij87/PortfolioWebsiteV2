<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINK Playlist</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22white%22>ðŸŽµ</text></svg>">
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --accent-color: #1DB954;
            --border-color: #333333;
            --hover-bg: #282828;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
            position: relative;
        }
        
        .artist-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .artist-background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            filter: blur(10px) brightness(0.3);
        }
        
        .artist-background-image.active {
            opacity: 1;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 60pt; /* Updated from 48px to 60pt */
            font-weight: 700;
            margin-bottom: 8px;
            font-family: 'Roboto', sans-serif;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .playlist-item-thumbnail {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 15px;
            background-color: var(--hover-bg);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-weight: bold;
            font-size: 20px;
        }
        
        .playlist-item-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .playlist {
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .playlist-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .playlist-item:hover {
            background-color: var(--hover-bg);
        }
        
        .playlist-item.active {
            background-color: rgba(29, 185, 84, 0.1);
            border-left: 3px solid var(--accent-color);
        }
        
        .playlist-item:last-child {
            border-bottom: none;
        }
        
        .playlist-item-info {
            flex: 1;
        }
        
        .playlist-item-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .playlist-item-artist {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .playlist-item-duration {
            color: var(--text-secondary);
            font-size: 14px;
            margin-left: 15px;
        }
        
        .playlist-item-timestamp {
            color: var(--text-secondary);
            font-size: 14px;
            margin-right: 15px;
            min-width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .playlist-item-actions {
            display: flex;
            align-items: center;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            margin-left: 10px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .action-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .youtube-btn {
            color: #FF0000;
        }
        
        .spotify-btn {
            color: #1DB954;
        }
        
        .refresh-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .last-updated {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .refresh-btn {
            background-color: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 64px;  /* Doubled from 32px */
            height: 64px; /* Doubled from 32px */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .refresh-btn:hover {
            background-color: var(--hover-bg);
        }
        
        .refresh-btn svg {
            width: 32px;  /* Doubled from 16px */
            height: 32px; /* Doubled from 16px */
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Equalizer animation */
        .equalizer {
            display: flex;
            align-items: flex-end;
            height: 32px; /* Doubled the height */
            gap: 3px; /* Slightly increased gap */
            margin: 0 auto;
        }
        
        .equalizer-bar {
            width: 4px; /* Slightly wider bars */
            background-color: var(--accent-color);
            border-radius: 1px;
            transform-origin: bottom;
            animation: equalize 1.2s ease-in-out infinite;
        }
        
        .equalizer-bar:nth-child(1) { 
            animation-delay: 0.0s; 
            height: 10px;
            animation-duration: 0.7s; 
        }
        .equalizer-bar:nth-child(2) { 
            animation-delay: 0.3s; 
            height: 24px;
            animation-duration: 1.3s; 
        }
        .equalizer-bar:nth-child(3) { 
            animation-delay: 0.1s; 
            height: 14px;
            animation-duration: 0.8s; 
        }
        .equalizer-bar:nth-child(4) { 
            animation-delay: 0.4s; 
            height: 18px;
            animation-duration: 1.1s; 
        }
        
        @keyframes equalize {
            0% { transform: scaleY(0.3); }
            50% { transform: scaleY(1); }
            75% { transform: scaleY(0.6); }
            100% { transform: scaleY(0.3); }
        }
        
        .error {
            background-color: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        footer a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="artist-background" id="artist-background">
        <!-- Background images will be added here dynamically -->
    </div>
    
    <div class="container">
        <header>
            <h1>KINK Playlist</h1>
            <p class="subtitle">Live updates of songs played on KINK radio station</p>
        </header>
        
        <div class="refresh-bar">
            <div class="last-updated" id="last-updated">Last updated: --:--</div>
            <button class="refresh-btn" id="refresh-btn" title="Refresh Now">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
            </button>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
        </div>
        
        <div id="error" class="error">
            Failed to load playlist data. Please try again later.
        </div>
        
        <div id="playlist" class="playlist" style="display: none;">
            <!-- Playlist items will be inserted here -->
        </div>
        
        <footer>
            <p>Data provided by <a href="https://onlineradiobox.com/nl/kink/playlist/" target="_blank" rel="noopener noreferrer">onlineradiobox.com</a></p>
        </footer>
    </div>
    
    <script>
        // DOM elements
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const playlistEl = document.getElementById('playlist');
        const lastUpdatedEl = document.getElementById('last-updated');
        const refreshBtn = document.getElementById('refresh-btn');
        const artistBackgroundEl = document.getElementById('artist-background');

        // Constants
        const PLAYLIST_URL = 'https://onlineradiobox.com/nl/kink/playlist/?cs=nl.slamfm';
        const REFRESH_INTERVAL = 60; // seconds
        
        // Variables
        let isRefreshing = false;
        let songs = [];
        let currentSongIndex = 0;
        let currentBackgroundImage = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchPlaylist();
            startAutoRefresh();
            
            // Event listeners
            refreshBtn.addEventListener('click', handleManualRefresh);
        });

        // Start auto refresh
        function startAutoRefresh() {
            // Auto refresh every REFRESH_INTERVAL seconds
            setInterval(() => {
                fetchPlaylist();
            }, REFRESH_INTERVAL * 1000);
        }

        // Handle manual refresh button click
        async function handleManualRefresh() {
            if (isRefreshing) return;
            await fetchPlaylist();
        }

        // Generate album art color based on artist and title
        function generateAlbumArtColor(artist, title) {
            // Create a deterministic hash from artist and title
            let hash = 0;
            const str = `${artist}${title}`;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            
            // Use positive hash value
            hash = Math.abs(hash);
            
            // Use a set of predefined colors
            const colors = [
                '#1DB954', '#4285F4', '#EA4335', '#FBBC05', '#34A853', 
                '#FF9900', '#8E44AD', '#2ECC71', '#E74C3C', '#3498DB'
            ];
            
            // Select a color based on the hash
            const colorIndex = hash % colors.length;
            return colors[colorIndex];
        }

        // Fetch playlist data
        async function fetchPlaylist() {
            try {
                setRefreshing(true);
                showLoading();
                
                const response = await fetch('https://corsproxy.io/?' + encodeURIComponent(PLAYLIST_URL));
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch playlist: ${response.status}`);
                }
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Find the playlist table
                const table = doc.querySelector('table');
                
                if (!table) {
                    throw new Error('Playlist table not found');
                }
                
                // Parse songs from the table
                const newSongs = [];
                const rows = table.querySelectorAll('tr');
                
                // Process each row in the table
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const cells = row.querySelectorAll('td');
                    
                    if (cells.length >= 2) {
                        const timestamp = cells[0].textContent.trim();
                        const songText = cells[1].textContent.trim();
                        
                        let artist = 'Unknown';
                        let title = songText;
                        
                        if (songText.includes(' - ')) {
                            [artist, title] = songText.split(' - ', 2);
                        }
                        
                        artist = artist.trim();
                        title = title.trim();
                        
                        // Try to extract cover art from the row
                        let coverArt = null;
                        const imgElement = row.querySelector('img');
                        if (imgElement && imgElement.src) {
                            coverArt = imgElement.src;
                        }
                        
                        // Generate album art color as fallback
                        const albumArtColor = generateAlbumArtColor(artist, title);
                        
                        newSongs.push({
                            timestamp,
                            artist,
                            title,
                            isLive: timestamp.toLowerCase() === 'live',
                            coverArt,
                            albumArtColor,
                            duration: generateRandomDuration()
                        });
                    }
                }
                
                // Update songs array
                songs = newSongs;
                
                // Update the UI with the songs
                updatePlaylist(songs);
                showContent();
            } catch (error) {
                console.error('Error fetching playlist:', error);
                showError();
            } finally {
                setRefreshing(false);
            }
        }

        // Generate random duration for display purposes
        function generateRandomDuration() {
            const minutes = Math.floor(Math.random() * 4) + 1;
            const seconds = Math.floor(Math.random() * 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Convert timestamp to Netherlands timezone (CET/CEST)
        function convertToNetherlandsTime(timestamp) {
            if (timestamp.toLowerCase() === 'live') {
                return timestamp;
            }
            
            try {
                // Parse the timestamp and adjust for 6-hour difference
                const [hours, minutes] = timestamp.split(':').map(Number);
                
                // Add 6 hours to correct the timezone difference
                let adjustedHours = hours + 6;
                
                // Handle day rollover
                if (adjustedHours >= 24) {
                    adjustedHours -= 24;
                }
                
                // Format as HH:MM
                return `${adjustedHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            } catch (error) {
                console.error('Error converting timestamp:', error);
                return timestamp; // Return original timestamp if conversion fails
            }
        }

        // Get initials from artist name
        function getInitials(name) {
            if (!name || name === 'Unknown') return '?';
            return name.split(' ')
                .map(word => word[0])
                .join('')
                .substring(0, 2)
                .toUpperCase();
        }

        // Update playlist in the UI
        function updatePlaylist(songs) {
            // Clear existing playlist
            playlistEl.innerHTML = '';
            
            // Update last updated time (in Netherlands timezone)
            const now = new Date();
            lastUpdatedEl.textContent = `Last updated: ${now.toLocaleTimeString('nl-NL', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false
            })}`;
            
            // Update background with current artist (first song or live song)
            const currentSong = songs.find(song => song.isLive) || songs[0];
            if (currentSong) {
                updateArtistBackground(currentSong);
            }
            
            // Add songs to the playlist
            songs.forEach((song, index) => {
                const item = document.createElement('div');
                item.className = `playlist-item ${index === currentSongIndex ? 'active' : ''}`;
                
                // Timestamp
                const timestamp = document.createElement('div');
                timestamp.className = 'playlist-item-timestamp';
                
                if (song.isLive) {
                    // Create equalizer animation instead of LIVE text
                    const equalizer = document.createElement('div');
                    equalizer.className = 'equalizer';
                    
                    // Create 4 bars for the equalizer
                    for (let i = 0; i < 4; i++) {
                        const bar = document.createElement('div');
                        bar.className = 'equalizer-bar';
                        equalizer.appendChild(bar);
                    }
                    
                    timestamp.appendChild(equalizer);
                } else {
                    timestamp.textContent = convertToNetherlandsTime(song.timestamp);
                }
                
                // Thumbnail
                const thumbnail = document.createElement('div');
                thumbnail.className = 'playlist-item-thumbnail';
                
                if (song.coverArt) {
                    // Use actual cover art if available
                    const img = document.createElement('img');
                    img.src = song.coverArt;
                    img.alt = `${song.artist} - ${song.title}`;
                    img.onerror = function() {
                        // Fallback to color background with initials if image fails to load
                        this.style.display = 'none';
                        thumbnail.style.backgroundColor = song.albumArtColor;
                        thumbnail.textContent = getInitials(song.artist);
                    };
                    thumbnail.appendChild(img);
                } else {
                    // Use color background with initials as fallback
                    thumbnail.style.backgroundColor = song.albumArtColor;
                    thumbnail.textContent = getInitials(song.artist);
                }
                
                // Song info
                const info = document.createElement('div');
                info.className = 'playlist-item-info';
                
                const title = document.createElement('div');
                title.className = 'playlist-item-title';
                title.textContent = song.title;
                
                const artist = document.createElement('div');
                artist.className = 'playlist-item-artist';
                artist.textContent = song.artist;
                
                info.appendChild(title);
                info.appendChild(artist);
                
                // Duration column removed
                
                // Actions
                const actions = document.createElement('div');
                actions.className = 'playlist-item-actions';
                
                // YouTube search button
                const youtubeBtn = document.createElement('button');
                youtubeBtn.className = 'action-btn youtube-btn';
                youtubeBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"></path></svg>';
                youtubeBtn.title = 'Search on YouTube';
                youtubeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(`${song.artist} ${song.title}`)}`, '_blank');
                });
                
                // Spotify search button
                const spotifyBtn = document.createElement('button');
                spotifyBtn.className = 'action-btn spotify-btn';
                spotifyBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.48.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"></path></svg>';
                spotifyBtn.title = 'Open in Spotify';
                spotifyBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Use Spotify URI protocol to open the app instead of the web URL
                    window.open(`spotify:search:${encodeURIComponent(`${song.artist} ${song.title}`)}`, '_blank');
                });
                
                actions.appendChild(youtubeBtn);
                actions.appendChild(spotifyBtn);
                
                // Append all elements to the item
                item.appendChild(timestamp);
                item.appendChild(thumbnail);
                item.appendChild(info);
                // Duration element removed from here
                item.appendChild(actions);
                
                // Add click event to the item
                item.addEventListener('click', () => {
                    // Update current song index
                    currentSongIndex = index;
                    
                    // Update active class
                    document.querySelectorAll('.playlist-item').forEach((el, i) => {
                        el.classList.toggle('active', i === index);
                    });
                    
                    // Update background with selected artist
                    updateArtistBackground(song);
                });
                
                // Append the item to the playlist
                playlistEl.appendChild(item);
            });
        }

        // Update artist background image
        function updateArtistBackground(song) {
            // Skip if no song or same as current
            if (!song || (currentBackgroundImage && currentBackgroundImage.dataset.artist === song.artist)) {
                return;
            }
            
            // Create new image element
            const newImage = document.createElement('img');
            newImage.className = 'artist-background-image';
            newImage.dataset.artist = song.artist;
            
            // Try to use the song's cover art first
            if (song.coverArt) {
                newImage.src = song.coverArt;
            } else {
                // Directly use Unsplash for artist images - simpler approach
                const artistName = encodeURIComponent(song.artist);
                newImage.src = `https://source.unsplash.com/1600x900/?${artistName},music,band`;
                
                // Log for debugging
                console.log(`Loading background image for: ${song.artist}`);
            }
            
            // Add the new image to the background
            artistBackgroundEl.appendChild(newImage);
            
            // Handle image load event
            newImage.onload = function() {
                console.log(`Background image loaded for: ${song.artist}`);
                // Fade in the new image
                setTimeout(() => {
                    newImage.classList.add('active');
                    
                    // Remove old image after transition
                    if (currentBackgroundImage) {
                        currentBackgroundImage.classList.remove('active');
                        setTimeout(() => {
                            if (currentBackgroundImage && currentBackgroundImage.parentNode) {
                                currentBackgroundImage.parentNode.removeChild(currentBackgroundImage);
                            }
                        }, 1500); // Match the transition duration
                    }
                    
                    // Update current background reference
                    currentBackgroundImage = newImage;
                }, 50);
            };
            
            // Handle image error
            newImage.onerror = function() {
                // Try a fallback to Unsplash if the image fails to load
                this.src = `https://source.unsplash.com/1600x900/?${encodeURIComponent(song.artist)},music,concert`;
            };
        }

        // Show loading state
        function showLoading() {
            loadingEl.style.display = 'flex';
            errorEl.style.display = 'none';
            playlistEl.style.display = 'none';
        }
        
        // Show content
        function showContent() {
            loadingEl.style.display = 'none';
            errorEl.style.display = 'none';
            playlistEl.style.display = 'block';
        }
        
        // Show error
        function showError() {
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
            playlistEl.style.display = 'none';
        }
        
        // Set refreshing state
        function setRefreshing(state) {
            isRefreshing = state;
            refreshBtn.disabled = state;
        }
    </script>
</body>
</html>